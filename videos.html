<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª - Ù…Ù†ØµØ© 1383</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script>
    // ğŸš¨ 1. Configuration - Ù„Ø§Ø²Ù… ØªØ­Ø· Ù†ÙØ³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ÙŠ ÙÙŠ index.html
    const firebaseConfig = {
      apiKey: "AIzaSyBK6FZF3LW83qaUHBKYTfiVd2Ozrd1Rf2g",
      authDomain: "thanawy-1383.firebaseapp.com",
      databaseURL: "https://thanawy-1383-default-rtdb.firebaseio.com",
      projectId: "thanawy-1383",
      storageBucket: "thanawy-1383.firebasestorage.app",
      messagingSenderId: "1026664406457",
      appId: "1:1026664406457:web:87d71f7e41bef36ba0aa68",
      measurementId: "G-J5R2EFM2D0"
    };

    // ğŸš¨ 2. Ø¹Ù†ÙˆØ§Ù† ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù„ÙŠ Ù‡ØªØ±Ø¬Ø¹ Ù„ÙŠÙ‡Ø§
    const LOGIN_PAGE_URL = "https://1383ss.vercel.app"; 

    // Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
    function redirectToLogin(reason) {
        // Ø¨Ù†Ø³ØªØ®Ø¯Ù… replace Ø¹Ø´Ø§Ù† Ø§Ù„ØµÙØ­Ø© Ø¯ÙŠ Ù…ØªØªØ³Ø¬Ù„Ø´ ÙÙŠ Ø§Ù„Ù€ Browser History
        window.location.replace(LOGIN_PAGE_URL);
    }

    // *******************************************************************

    const activeCode = localStorage.getItem('activeCode');
    const localDeviceId = localStorage.getItem('localDeviceId');

    // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ: Ù„Ùˆ Ù…ÙÙŠØ´ ÙƒÙˆØ¯ Ø£Ùˆ Device ID Ù…ØªØ³Ø¬Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§
    if (!activeCode || !localDeviceId) {
        redirectToLogin("Missing local code or Device ID.");
    } else {
        // 4. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Firebase
        
        if (typeof firebase === 'undefined' || firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        async function verifyCodeOnServer(code) {
            try {
                // Ø¨Ù†Ø­Ø§ÙˆÙ„ Ù†Ù‚Ø±Ø§ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒÙˆØ¯ Ø¯Ù‡ Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§ Ø¨ÙŠØ² Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø³
                const snapshot = await db.ref('approvedStudents/' + code).once('value');
                const data = snapshot.val();
                const now = Date.now();

                // Ø£. Ø§Ù„ÙƒÙˆØ¯ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯
                if (!data) {
                    redirectToLogin("Code not found.");
                    return;
                }

                // Ø¨. Ø§Ù„ÙƒÙˆØ¯ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
                if (data.expiry <= now) {
                    redirectToLogin("Code is expired.");
                    return;
                }
                
                // Ø¬. Ø§Ù„ÙƒÙˆØ¯ Ù…ÙØ¹Ø·Ù‘Ù„ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                if (data.isBlocked === true) {
                    redirectToLogin("Code is blocked.");
                    return;
                }
                
                // Ø¯. Ø§Ù„ÙƒÙˆØ¯ Ù…ÙØ¹Ù„ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø² ØªØ§Ù†ÙŠ
                const storedDeviceId = data.deviceId;
                
                if (!storedDeviceId || storedDeviceId !== localDeviceId) {
                    // Ø¹Ø´Ø§Ù† Ø§Ù„Ø£Ù…Ø§Ù†ØŒ Ø¨Ù†Ù…Ø³Ø­ Ø§Ù„Ø¯Ø§ØªØ§ Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¹Ø´Ø§Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ ÙŠØ±Ø¬Ø¹ ÙŠØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ ØªØ§Ù†ÙŠ
                    localStorage.removeItem('activeCode');
                    localStorage.removeItem('localDeviceId');
                    redirectToLogin("Code linked to another device.");
                    return;
                }

                // Ù„Ùˆ ÙˆØµÙ„ Ù„Ø­Ø¯ Ù‡Ù†Ø§ ÙŠØ¨Ù‚Ù‰: âœ… Ø§Ù„ÙƒÙˆØ¯ Ø³Ù„ÙŠÙ… ÙˆÙ…ÙØ¹Ù„ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø¬Ù‡Ø§Ø²
                // Ø®Ù„Ø§ØµØŒ Ø³ÙŠØ¨Ù‡ ÙŠÙƒÙ…Ù„ ÙˆÙŠØ´ÙˆÙ Ø§Ù„Ù…Ø­ØªÙˆÙ‰

            } catch (error) {
                // Ù„Ùˆ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…ØŒ Ø§Ù„Ø£Ù…Ø§Ù† ÙŠÙ‚ØªØ¶ÙŠ Ø¥Ù†Ù†Ø§ Ù†Ø±Ø¬Ø¹Ù‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
                // Ø¹Ø´Ø§Ù† Ù…Ù†Ø¹Ø§Ù‹ Ù„Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡ Ù„Ùˆ Ø§Ù„Ù€ Server ÙƒØ§Ù† ÙˆØ§Ù‚Ø¹
                redirectToLogin("Verification server error.");
            }
        }

        // Ø¥Ø¨Ø¯Ø£ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù‚Ù‚
        verifyCodeOnServer(activeCode);
    }
</script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@500;700;900&display=swap" rel="stylesheet">
  <style>
    /*
* Ø´Ø§ØªÙŠ - Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù€ Dark Mode Ù„ØµÙØ­Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚
*/
@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@500;700;900&display=swap');

body {
    font-family: 'Cairo', sans-serif;
    background: #0d0d0d;
    color: #fff;
    margin: 0;
    padding: 15px;
}

header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

header h1 {
    /* ğŸ”µ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ */
    color: #3498db;
    font-size: 1.6rem;
    margin: 0;
    font-weight: 900;
    text-align: center;
    flex-grow: 1;
}

#back {
    /* ğŸ”µ Ø®Ù„ÙÙŠØ© ÙˆØ¥Ø·Ø§Ø± ÙˆÙ„ÙˆÙ† Ø£Ø²Ø±Ù‚ Ø´ÙØ§Ù/ØµÙ„Ø¨ */
    background: rgba(52, 152, 219, 0.1);
    border: 1.5px solid #3498db;
    color: #3498db;
    padding: 6px 10px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: 0.3s;
    margin-left: 5px;
}

#back:hover {
    /* ğŸ”µ Ø¯Ø±Ø¬Ø© Ø£Ø²Ø±Ù‚ Ø£ØºÙ…Ù‚ ÙÙŠ Ø§Ù„Ù€ hover */
    background: rgba(52, 152, 219, 0.2);
    transform: translateY(-1px);
}

#videos-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    max-width: 1100px;
    margin: auto;
}

.video-box {
    background: #1a1a1a;
    /* ğŸ”µ Ø¥Ø·Ø§Ø± Ø£Ø²Ø±Ù‚ Ø´ÙØ§Ù */
    border: 1px solid rgba(52, 152, 219, 0.15);
    border-radius: 12px;
    padding: 12px;
    transition: 0.3s;
    overflow: hidden;
    /* ğŸ”µ Ø¸Ù„ Ø£Ø²Ø±Ù‚ Ø®ÙÙŠÙ */
    box-shadow: 0 0 10px rgba(52, 152, 219, 0.05);
}

.video-box:hover {
    transform: translateY(-4px);
    /* ğŸ”µ Ø¸Ù„ Ø£Ø²Ø±Ù‚ ÙˆØ§Ø¶Ø­ ÙÙŠ Ø§Ù„Ù€ hover */
    box-shadow: 0 0 18px rgba(52, 152, 219, 0.25);
}

.video-title {
    font-size: 18px;
    font-weight: 800;
    /* ğŸ”µ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ */
    color: #3498db;
    text-align: center;
    margin-bottom: 8px;
}

.thumb {
    background: #000;
    border-radius: 10px;
    height: 160px;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    cursor: pointer;
}

.thumb::after {
    content: "â–¶";
    position: absolute;
    font-size: 40px;
    /* ğŸ”µ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ù„Ø²Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ */
    color: #3498db;
    text-shadow: 0 0 10px rgba(0, 0, 0, 0.9);
    transition: transform 0.3s ease;
}

.thumb:hover::after {
    transform: scale(1.1);
}

.loading, .error {
    text-align: center;
    /* ğŸ”µ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ */
    color: #3498db;
    font-size: 17px;
    padding: 20px;
}

footer {
    text-align: center;
    color: #888;
    margin-top: 35px;
    font-size: 0.85rem;
    /* ğŸ”µ Ø®Ø· Ø£Ø²Ø±Ù‚ Ø´ÙØ§Ù ÙØ§ØµÙ„ */
    border-top: 1px solid rgba(52, 152, 219, 0.1);
    padding-top: 15px;
}

footer span {
    /* ğŸ”µ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ */
    color: #3498db;
}

/* âœ… Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬ÙˆØ¯Ø§Øª */
.popup {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999;
    display: none;
}

.popup-content {
    background: #1a1a1a;
    /* ğŸ”µ Ø¥Ø·Ø§Ø± Ø£Ø²Ø±Ù‚ */
    border: 2px solid #3498db;
    border-radius: 14px;
    padding: 20px;
    text-align: center;
    width: 300px;
    /* ğŸ”µ Ø¸Ù„ Ø£Ø²Ø±Ù‚ */
    box-shadow: 0 0 20px rgba(52, 152, 219, 0.2);
}

.popup-content h3 {
    /* ğŸ”µ Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ */
    color: #3498db;
    margin-bottom: 15px;
    font-size: 20px;
}

.quality-btn {
    display: block;
    /* ğŸ”µ Ø®Ù„ÙÙŠØ© Ø²Ø±Ù‚Ø§Ø¡ */
    background: #3498db;
    /* âšªï¸ ØªÙ… ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø®Ø· Ù„Ù„Ø£Ø¨ÙŠØ¶ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø±Ø¤ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡ */
    color: #fff;
    border: none;
    padding: 10px 15px;
    margin: 8px auto;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: 0.3s;
    width: 80%;
}

.quality-btn:hover {
    /* ğŸ”µ Ø£Ø²Ø±Ù‚ Ø£ØºÙ…Ù‚ Ù„Ù„Ù€ hover */
    background: #2980b9;
    transform: translateY(-2px);
}

.cancel-btn {
    margin-top: 10px;
    background: none;
    /* ğŸ”µ Ø¥Ø·Ø§Ø± ÙˆÙ„ÙˆÙ† Ø®Ø· Ø£Ø²Ø±Ù‚ */
    border: 1px solid #3498db;
    color: #3498db;
    padding: 8px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
}

.cancel-btn:hover {
    /* ğŸ”µ Ø®Ù„ÙÙŠØ© Ø£Ø²Ø±Ù‚ Ø´ÙØ§Ù ÙÙŠ Ø§Ù„Ù€ hover */
    background: rgba(52, 152, 219, 0.1);
}
  </style>
</head>

<body>
  <header>
    <button id="back">â¬… Ø±Ø¬ÙˆØ¹</button>
    <h1>ğŸ¬ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª</h1>
    <div style="width:35px;"></div>
  </header>

  <main>
    <div id="videos-container">
      <div class="loading">â³....ğ‘³ğ’ğ’‚ğ’…ğ’Šğ’ğ’ˆ</div>
    </div>
  </main>

  <footer>
    Â© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù…Ù†ØµØ© <span>1383</span> ğŸ”¥
  </footer>

  <!-- âœ… Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬ÙˆØ¯Ù‡ -->
  <div id="popup" class="popup">
    <div class="popup-content">
      <h3>Ø§Ø®ØªØ± Ø§Ù„Ø¬ÙˆØ¯Ø© ğŸ¥</h3>
      <div id="quality-options"></div>
      <button class="cancel-btn" onclick="closePopup()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const subject = urlParams.get("subject");
    const teacher = urlParams.get("teacher");
    const chapter = urlParams.get("chapter");
    const lecture = urlParams.get("lecture");

    const videosContainer = document.getElementById("videos-container");
    const backBtn = document.getElementById("back");
    const popup = document.getElementById("popup");
    const qualityOptions = document.getElementById("quality-options");

    backBtn.onclick = () => {
      window.location.href = `lecture_name.html?subject=${encodeURIComponent(subject)}&teacher=${encodeURIComponent(teacher)}&chapter=${encodeURIComponent(chapter)}`;
    };

    function normalize(str) {
      return (str || "").trim().replace(/[\s.\-Ù€_]/g, "").toLowerCase();
    }

    function closePopup() {
      popup.style.display = "none";
    }

    function showQualityOptions(video) {
      qualityOptions.innerHTML = "";
      popup.style.display = "flex";

      video.links.forEach(link => {
        const btn = document.createElement("button");
        btn.className = "quality-btn";
        btn.textContent = link.label ? link.label + "p" : "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
        btn.onclick = () => {
          localStorage.setItem("video_sources", JSON.stringify(link));
          localStorage.setItem("video_title", video.name);
          window.location.href = "player.html";
        };
        qualityOptions.appendChild(btn);
      });
    }

    async function loadVideos() {
      try {
        const res = await fetch("coursatk_scraped_data.json");
        if (!res.ok) throw new Error("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        const json = await res.json();
        const data = json.data || json;

        const wantedSubject = normalize(subject);
        const wantedTeacher = normalize(teacher);
        const wantedChapter = normalize(chapter);
        const wantedLecture = normalize(lecture);

        const videos = [];

        (data || []).forEach((year) => {
          (year.subjects || []).forEach((sub) => {
            if (normalize(sub.subject_name).includes(wantedSubject)) {
              (sub.teachers || []).forEach((t) => {
                if (normalize(t.teacher_name).includes(wantedTeacher)) {
                  (t.chapters || []).forEach((chap) => {
                    if (normalize(chap.chapter_name).includes(wantedChapter)) {
                      (chap.lectures || []).forEach((lec) => {
                        if (!lecture || normalize(lec.lecture_name).includes(wantedLecture)) {
                          (lec.videos || []).forEach((vid) => {
                            if (vid.links && vid.links.length > 0) {
                              videos.push({
                                name: vid.video_name,
                                links: vid.links
                              });
                            }
                          });
                        }
                      });
                    }
                  });
                }
              });
            }
          });
        });

        videosContainer.innerHTML = "";

        if (videos.length === 0) {
          videosContainer.innerHTML = "<div class='error'>âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©.</div>";
          return;
        }

        videos.forEach((video) => {
          const box = document.createElement("div");
          box.className = "video-box";
          box.innerHTML = `
            <div class="video-title">${video.name}</div>
            <div class="thumb"></div>
          `;
          box.querySelector(".thumb").onclick = () => showQualityOptions(video);
          videosContainer.appendChild(box);
        });

      } catch (err) {
        console.error(err);
        videosContainer.innerHTML = "<div class='error'>âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>";
      }
    }

    loadVideos();
  </script>
</body>
</html>
